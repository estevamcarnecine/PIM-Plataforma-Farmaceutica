# Audit Log Sink Interface

## Purpose
The Audit Log Sink Interface defines the API contract the FFI microservice uses to persist every auditable event (success/failure, data reception, checksum mismatch). Because FDA 21 CFR Part 11 and GAMP 5 both require immutable, timestamped, human-readable records for traceability, the interface must guarantee:

- immediate persistence before taking recovery actions,
- inclusion of context fields (batch ID, source module, checksum) for downstream verification,
- write-only access from the calling service so only the audit pipeline can mutate entries.

## API Model

### Message Envelope

| Field | Type | Description |
| --- | --- | --- |
| `event_id` | UUID/v4 string | Unique identifier for the logged event. |
| `timestamp` | ISO 8601 string (UTC) | Generated by the audit sink to avoid clock skew; the caller provides local offset if necessary via `source_timestamp`. |
| `source` | Enum | One of `["EDGE_C", "FFI_INTEGRATION", "REPOSITORY", "AI_MODEL"]`. |
| `level` | Enum | `["INFO", "SUCCESS", "WARNING", "ERROR", "CRITICAL"]`. |
| `event_type` | Enum | `["BATCH_STARTED", "BATCH_COMPLETED", "RECORD_PERSISTED", "CHECKSUM_MISMATCH", "AUTH_FAILURE", "CALCULATION_ERROR", "SECURE_TRANSMIT"]`. |
| `details` | Object | Free-form JSON that MUST include `batch_id`, `record_index`, and `checksum` when applicable. |
| `correlation_id` | UUID string | Tracks the request flow across services (edge → FFI → audit). |
| `source_timestamp` | ISO 8601 string (optional) | When available, the originating module's local timestamp. |

### Transport
- **Protocol:** HTTPS/TLS (mutual authentication when possible) or gRPC over TLS if both sides agree.  
- **Endpoint:** `POST /audit/events` with JSON payload above.  
- **Headers:**  
  - `X-Audit-Auth` – HMAC or JWT as agreed (must be validated before processing).  
  - `X-Correlation-ID` – propagated for observability.  

### Response
| Field | Type | Description |
| --- | --- | --- |
| `status` | `"ACCEPTED"` or `"REJECTED"` | `ACCEPTED` means the event is encrypted, signed, and durably written. `REJECTED` returns a JSON body describing the reason. |
| `server_timestamp` | ISO 8601 | Audit sink's canonical timestamp for the entry. |
| `log_id` | Immutable integer/string | Reference for regulators/auditors.

## Deployment Requirements
- The service must write into the VLAN Audit segment and expose a read-only audit portal for compliance reviews while restricting modification rights.  
- Backups (write-once or append-only storage) must be kept per GAMP 5 Operation phase requirements.  
- Every audit entry must include a checksum/hash that can be verified end-to-end with the C module’s integrity hash to ensure tamper detection.

## Security & Compliance Notes
- TLS 1.2+ with pinned certificates, mutual auth if hardware caps allow.  
- All data is append-only; any administrative corrections must create a compensating entry with the reason.  
- Log rotation occurs daily with signed digests preserved for at least 3 years per FDA guidance.

## Next Step
Define the shared library or SDK that the FFI microservice uses to serialize this envelope and post to the audit sink (with retries/backoff). This ensures that first PRs hitting this interface can easily emit compliant audit entries.

